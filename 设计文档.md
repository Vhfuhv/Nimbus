# Nimbus - æ™ºèƒ½å¤©æ°”åŠ©æ‰‹è®¾è®¡æ–‡æ¡£

> åŸºäº Spring AI çš„è‡ªç„¶è¯­è¨€å¤©æ°”æŸ¥è¯¢ä¸ç©¿æ­æ¨èç³»ç»Ÿ

---

## ç›®å½•

1. [é¡¹ç›®æ¦‚è¿°](#1-é¡¹ç›®æ¦‚è¿°)
2. [æŠ€æœ¯æ ˆé€‰å‹](#2-æŠ€æœ¯æ ˆé€‰å‹)
3. [ç³»ç»Ÿæ¶æ„](#3-ç³»ç»Ÿæ¶æ„)
4. [æ¨¡å—ç»“æ„](#4-æ¨¡å—ç»“æ„)
5. [æ ¸å¿ƒæ•°æ®æµè½¬](#5-æ ¸å¿ƒæ•°æ®æµè½¬)
6. [é¢†åŸŸæ¨¡å‹](#6-é¢†åŸŸæ¨¡å‹)
7. [å…³é”®å®ç°ç‚¹](#7-å…³é”®å®ç°ç‚¹)
8. [API æ¥å£è®¾è®¡](#8-api-æ¥å£è®¾è®¡)
9. [é…ç½®ç®¡ç†](#9-é…ç½®ç®¡ç†)
10. [å¼‚å¸¸å¤„ç†ä¸é™çº§](#10-å¼‚å¸¸å¤„ç†ä¸é™çº§)
11. [æµ‹è¯•ç­–ç•¥](#11-æµ‹è¯•ç­–ç•¥)
12. [æ‰©å±•è§„åˆ’](#12-æ‰©å±•è§„åˆ’)
13. [å¼€å‘é‡Œç¨‹ç¢‘](#13-å¼€å‘é‡Œç¨‹ç¢‘)
14. [å‚è€ƒèµ„æº](#14-å‚è€ƒèµ„æº)

---

## 1. é¡¹ç›®æ¦‚è¿°

### 1.1 é¡¹ç›®èƒŒæ™¯

Nimbus æ˜¯ä¸€ä¸ªåŸºäº **Spring AI** çš„æ™ºèƒ½å¤©æ°”åŠ©æ‰‹ï¼Œé€šè¿‡è‡ªç„¶è¯­è¨€äº¤äº’ä¸ºç”¨æˆ·æä¾›ç²¾å‡†çš„å¤©æ°”æŸ¥è¯¢å’Œä¸ªæ€§åŒ–ç©¿è¡£å»ºè®®ã€‚é¡¹ç›®æ—¨åœ¨å®è·µ LLM å·¥ç¨‹åŒ–èƒ½åŠ›ï¼Œå°† AI èƒ½åŠ›æ— ç¼é›†æˆåˆ°ä¼ ç»Ÿ Java åº”ç”¨ä¸­ã€‚

### 1.2 æ ¸å¿ƒç‰¹æ€§

| ç‰¹æ€§ | è¯´æ˜ |
|-----|------|
| ğŸ¤– AI æ„å›¾è¯†åˆ« | è‡ªç„¶è¯­è¨€ç†è§£ï¼Œæ— éœ€è®°å¿†å›ºå®šæŒ‡ä»¤ |
| ğŸŒ¤ï¸ ç²¾å‡†å¤©æ°” | æ¥å…¥å’Œé£å¤©æ°”ä¸“ä¸š API |
| ğŸ§¥ æ™ºèƒ½ç©¿æ­ | åŸºäºå¤©æ°”æ•°æ®çš„ä¸ªæ€§åŒ–ç©¿è¡£æ¨è |
| âš¡ æé€Ÿå“åº” | Redis + Caffeine å¤šçº§ç¼“å­˜ |
| ğŸ›¡ï¸ ç¨³å®šå¯é  | ç†”æ–­é™çº§ï¼ŒæœåŠ¡å¯ç”¨æ€§ä¿éšœ |

### 1.3 ç›®æ ‡ç”¨æˆ·

- **é€šå‹¤æ—**ï¼šå¿«é€Ÿäº†è§£ä»Šæ—¥å¤©æ°”ä¸ç©¿æ­
- **å·®æ—…äººå£«**ï¼šæå‰æŒæ¡ç›®çš„åœ°å¤©æ°”çŠ¶å†µ
- **æˆ·å¤–çˆ±å¥½è€…**ï¼šå…³æ³¨å¤©æ°”å˜åŒ–è¶‹åŠ¿

---

## 2. æŠ€æœ¯æ ˆé€‰å‹

| å±‚çº§           | æŠ€æœ¯                             | ç†ç”±                                            |
| ------------ | ------------------------------ | --------------------------------------------- |
| **AI å±‚**     | Spring AI (OpenAI/æ™ºè°±/DeepSeek) | ç»Ÿä¸€ç®¡ç† Prompt å’Œ Function Callingï¼Œç®€å†å†™"LLM å·¥ç¨‹åŒ–å®è·µ" |
| **æ•°æ®å±‚**      | Redis + Caffeine æœ¬åœ°ç¼“å­˜          | å¤©æ°”æ•°æ® 1h è¿‡æœŸï¼Œé˜²å’Œé£ QPS é™åˆ¶ï¼›çƒ­ç‚¹åŸå¸‚å†…å­˜ç¼“å­˜æé€Ÿ              |
| **HTTP å®¢æˆ·ç«¯** | WebClient (WebFlux)            | éé˜»å¡è°ƒå’Œé£ APIï¼Œåç»­æ‰©å±•å¹¶å‘æŠ“å–ä¸å¡çº¿ç¨‹                       |
| **ä»»åŠ¡è°ƒåº¦**     | Spring Scheduler + å¼‚æ­¥ @Async   | å®šæ—¶åˆ·æ–°å¤©æ°”æ•°æ®ï¼Œç”¨æˆ·æŸ¥è¯¢èµ°ç¼“å­˜                              |
| **æ•°æ®æ˜ å°„**     | Jackson + Record(Java 17+)     | å’Œé£ JSON ç›´æ¥ååºåˆ—åŒ–ï¼ŒRecord çœæ ·æ¿ä»£ç                    |





### 2.1 Spring AI ç‰ˆæœ¬è¯´æ˜

| ç»„ä»¶ | ç‰ˆæœ¬ | è¯´æ˜ |
|-----|-----|-----|
| spring-ai-bom | 1.0.0-M3 | ç›®å‰æœ€æ–°é‡Œç¨‹ç¢‘ç‰ˆæœ¬ |
| spring-ai-openai-spring-boot-starter | 1.0.0-M3 | OpenAI æ”¯æŒ |
| spring-ai-zhipuai-spring-boot-starter | 1.0.0-M3 | æ™ºè°± AI æ”¯æŒ |
| spring-ai-ollama-spring-boot-starter | 1.0.0-M3 | æœ¬åœ° Ollama æ”¯æŒï¼ˆå¯é€‰ï¼‰ |

**Maven é…ç½®ç¤ºä¾‹ï¼š**

```xml
<dependencyManagement>
    <dependencies>
        <dependency>
            <groupId>org.springframework.ai</groupId>
            <artifactId>spring-ai-bom</artifactId>
            <version>1.0.0-M3</version>
            <type>pom</type>
            <scope>import</scope>
        </dependency>
    </dependencies>
</dependencyManagement>
```

---

## 3. ç³»ç»Ÿæ¶æ„

```mermaid
graph TB
    subgraph ç”¨æˆ·å±‚
        U[ç”¨æˆ·/å‰ç«¯]
    end

    subgraph æ¥å£å±‚
        API[Nimbus API
        /nimbus/chat]
    end

    subgraph åº”ç”¨å±‚
        IC[æ„å›¾è¯†åˆ«æœåŠ¡]
        WG[å¤©æ°”ç½‘å…³æœåŠ¡]
        CA[ç©¿è¡£å»ºè®®æœåŠ¡]
    end

    subgraph é¢†åŸŸå±‚
        DM[é¢†åŸŸæ¨¡å‹]
    end

    subgraph åŸºç¡€è®¾æ–½å±‚
        AI[Spring AI
        ChatClient]
        CACHE[(å¤šçº§ç¼“å­˜
        Redis+Caffeine)]
        QW[å’Œé£å¤©æ°” API]
    end

    U --> API
    API --> IC
    IC --> WG
    WG --> CA
    WG --> QW
    CA --> AI
    WG --> CACHE
    CA --> CACHE
```

---

## 4. æ¨¡å—ç»“æ„ï¼ˆMaven å¤šæ¨¡å—ï¼‰

```
nimbus/
â”œâ”€â”€ nimbus-bootstrap          // SpringBoot å¯åŠ¨å…¥å£ï¼Œä¾èµ–èšåˆ
â”‚   â””â”€â”€ src/main/java/com/nimbus/bootstrap/
â”‚       â””â”€â”€ NimbusApplication.java
â”‚
â”œâ”€â”€ nimbus-api                // REST æ¥å£å±‚
â”‚   â””â”€â”€ controller/
â”‚       â””â”€â”€ WeatherController.java    // /nimbus/chat ç«¯ç‚¹
â”‚
â”œâ”€â”€ nimbus-application        // åº”ç”¨æœåŠ¡å±‚
â”‚   â”œâ”€â”€ intent/
â”‚   â”‚   â”œâ”€â”€ Intent.java               // æ„å›¾æšä¸¾
â”‚   â”‚   â””â”€â”€ IntentClassifier.java     // æ„å›¾è¯†åˆ«å™¨
â”‚   â”œâ”€â”€ recommendation/
â”‚   â”‚   â”œâ”€â”€ ClothingAdvisor.java      // ç©¿è¡£å»ºè®®å™¨
â”‚   â”‚   â””â”€â”€ RuleEngine.java           // è§„åˆ™å¼•æ“
â”‚   â””â”€â”€ service/
â”‚       â””â”€â”€ WeatherQueryService.java  // æŸ¥è¯¢ç¼–æ’æœåŠ¡
â”‚
â”œâ”€â”€ nimbus-domain             // é¢†åŸŸå¯¹è±¡
â”‚   â”œâ”€â”€ model/
â”‚   â”‚   â”œâ”€â”€ City.java
â”‚   â”‚   â”œâ”€â”€ WeatherForecast.java
â”‚   â”‚   â”œâ”€â”€ DailyWeather.java
â”‚   â”‚   â””â”€â”€ ClothingAdvice.java
â”‚   â””â”€â”€ repository/
â”‚       â””â”€â”€ WeatherRepository.java    // é¢†åŸŸä»“å‚¨æ¥å£
â”‚
â”œâ”€â”€ nimbus-infrastructure     // åŸºç¡€è®¾æ–½å±‚
â”‚   â”œâ”€â”€ weather/
â”‚   â”‚   â”œâ”€â”€ QWeatherClient.java       // å’Œé£ API å®¢æˆ·ç«¯
â”‚   â”‚   â””â”€â”€ WeatherClientFallback.java // ç†”æ–­é™çº§
â”‚   â”œâ”€â”€ cache/
â”‚   â”‚   â”œâ”€â”€ CacheConfig.java          // Caffeine é…ç½®
â”‚   â”‚   â””â”€â”€ RedisCacheService.java    // Redis å°è£…
â”‚   â””â”€â”€ ai/
â”‚       â”œâ”€â”€ ChatClientConfig.java     // Spring AI é…ç½®
â”‚       â””â”€â”€ PromptTemplateLoader.java // Prompt åŠ è½½å™¨
â”‚
â””â”€â”€ nimbus-common             // å…¬å…±æ¨¡å—
    â”œâ”€â”€ exception/
    â”‚   â””â”€â”€ NimbusException.java
    â””â”€â”€ util/
        â””â”€â”€ JsonUtils.java
```

### 4.1 æ¨¡å—ä¾èµ–å…³ç³»

```
nimbus-bootstrap
    â†“
nimbus-api
    â†“
nimbus-application
    â†“
nimbus-domain â† nimbus-infrastructure
    â†“
nimbus-common
```





## 5. æ ¸å¿ƒæ•°æ®æµè½¬

### 5.1 æ—¶åºå›¾

```mermaid
sequenceDiagram
    autonumber
    participant U as ç”¨æˆ·
    participant API as WeatherController
    participant IC as IntentClassifier
    participant CR as CityResolver
    participant WG as WeatherGateway
    participant WA as WeatherAnalyzer
    participant CA as ClothingAdvisor
    participant RA as ResponseAssembler
    participant QW as QWeather API
    participant AI as Spring AI

    U->>API: POST /nimbus/chat<br/>{ "query": "åŒ—äº¬æ˜å¤©ç©¿å•¥" }
    activate API

    API->>IC: classify(query)
    activate IC
    IC-->>API: Intent.CLOTHING
    deactivate IC

    API->>CR: resolve("åŒ—äº¬")
    activate CR
    alt ç¼“å­˜å‘½ä¸­
        CR->>CR: ä» Redis å– LocationID
    else ç¼“å­˜æœªå‘½ä¸­
        CR->>QW: GET /geo/v2/city/lookup?q=åŒ—äº¬
        QW-->>CR: { "location": [{ "id": "101010100" }] }
        CR->>CR: å†™å…¥ Redis Hash
    end
    CR-->>API: City(locationId=101010100)
    deactivate CR

    API->>WG: fetchWeather(cityId)
    activate WG
    WG->>QW: GET /v7/weather/7d/{cityId}
    QW-->>WG: 7å¤©é¢„æŠ¥ JSON
    WG->>WG: Jackson ååºåˆ—åŒ– â†’ WeatherForecast
    WG-->>API: WeatherForecast
    deactivate WG

    API->>WA: analyze(forecast)
    activate WA
    WA->>AI: ChatClient.call(prompt, forecast)
    AI-->>WA: "æœªæ¥ä¸€å‘¨å…ˆæ™´åé›¨ï¼Œå‘¨ä¸‰é™æ¸©..."
    WA-->>API: summary
    deactivate WA

    API->>CA: advise(summary, forecast)
    activate CA
    CA->>AI: ChatClient.call(clothingPrompt)
    AI-->>CA: { "top": "è–„æ¯›è¡£", "bottom": "ç‰›ä»”è£¤", ... }
    CA-->>API: ClothingAdvice
    deactivate CA

    API->>RA: assemble(city, summary, forecast, advice)
    activate RA
    RA-->>API: WeatherResponse
    deactivate RA

    API-->>U: 200 OK + JSON Response
    deactivate API
```

### 5.2 æµç¨‹è¯´æ˜

| æ­¥éª¤ | ç»„ä»¶ | èŒè´£ |
|:---:|:---|:---|
| 1 | WeatherController | æ¥æ”¶ç”¨æˆ·æŸ¥è¯¢è¯·æ±‚ |
| 2-3 | IntentClassifier | è¯†åˆ«ç”¨æˆ·æ„å›¾ï¼ˆå¤©æ°”æŸ¥è¯¢/ç©¿è¡£å»ºè®®/ä¸¤è€…ï¼‰ |
| 4-8 | CityResolver | åŸå¸‚åç§°â†’LocationID æ˜ å°„ï¼Œä¼˜å…ˆèµ°ç¼“å­˜ |
| 9-12 | WeatherGateway | è°ƒç”¨å’Œé£ API è·å–å¤©æ°”æ•°æ® |
| 13-16 | WeatherAnalyzer | Spring AI åˆ†æå¤©æ°”è¶‹åŠ¿ |
| 17-20 | ClothingAdvisor | åŸºäº AI æ¨èç©¿æ­ |
| 21-23 | ResponseAssembler | ç»„è£…ç»Ÿä¸€å“åº”æ ¼å¼ |

---

## 6. é¢†åŸŸæ¨¡å‹

### 6.1 ç±»å›¾

```mermaid
classDiagram
    class City {
        +String locationId
        +String name
        +String adm1
        +String adm2
        +BigDecimal latitude
        +BigDecimal longitude
        +String timezone
    }

    class WeatherForecast {
        +City city
        +List~DailyWeather~ dailyList
        +LocalDateTime updateTime
        +String source
    }

    class DailyWeather {
        +LocalDate fxDate
        +String tempMax
        +String tempMin
        +String textDay
        +String textNight
        +String windDirDay
        +String windScaleDay
        +String humidity
        +String precip
        +String uvIndex
        +String vis
    }

    class ClothingAdvice {
        +String overview
        +ClothingItem top
        +ClothingItem bottom
        +ClothingItem shoes
        +ClothingItem extra
        +String aiReply
        +AdviceLevel level
    }

    class ClothingItem {
        +String name
        +String description
        +String reason
    }

    class Intent {
        <<enumeration>>
        WEATHER
        CLOTHING
        BOTH
        UNKNOWN
    }

    WeatherForecast "1" --> "*" DailyWeather
    WeatherForecast --> City
    ClothingAdvice "1" --> "4" ClothingItem
```

### 6.2 å®ä½“è¯´æ˜

| å®ä½“ | è¯´æ˜ | å…³é”®å­—æ®µ |
|:---|:---|:---|
| **City** | åŸå¸‚ä¿¡æ¯ | locationId(å’Œé£9ä½ID)ã€ç»çº¬åº¦ |
| **WeatherForecast** | å¤©æ°”é¢„æŠ¥èšåˆ | åŒ…å«7å¤©æ•°æ®ã€æ›´æ–°æ—¶é—´ |
| **DailyWeather** | å•æ—¥å¤©æ°” | æ¸©åº¦ã€å¤©æ°”çŠ¶å†µã€é£åŠ›æ¹¿åº¦ç­‰ |
| **ClothingAdvice** | ç©¿è¡£å»ºè®® | æ¦‚è¿°+å››ç±»å•å“+AIè‡ªç„¶è¯­è¨€å›å¤ |
| **Intent** | ç”¨æˆ·æ„å›¾æšä¸¾ | ç”¨äºè·¯ç”±åˆ°ä¸åŒå¤„ç†é€»è¾‘ |



## 7. å…³é”®å®ç°ç‚¹

### 7.1 æ„å›¾è¯†åˆ«

#### 7.1.1 æ–¹æ¡ˆå¯¹æ¯”

| æ–¹æ¡ˆ | ä¼˜ç‚¹ | ç¼ºç‚¹ | é€‚ç”¨åœºæ™¯ |
|:---|:---|:---|:---|
| **å…³é”®å­—åŒ¹é…** | é›¶æˆæœ¬ã€å¿«é€Ÿ | æ‰©å±•æ€§å·® | MVPé˜¶æ®µ |
| **æ­£åˆ™è¡¨è¾¾å¼** | ç²¾ç¡®æ§åˆ¶ | ç»´æŠ¤å¤æ‚ | å›ºå®šå¥å¼ |
| **LLMåˆ†ç±»** | å‡†ç¡®ç‡é«˜ã€è‡ªç„¶ | æœ‰Tokenæˆæœ¬ | ç”Ÿäº§ç¯å¢ƒ |

#### 7.1.2 è½»é‡çº§å®ç°ï¼ˆMVPï¼‰

```java
@Component
public class IntentClassifier {

    private static final List<String> CLOTHING_KEYWORDS = List.of(
        "ç©¿", "å¸¦ä¼", "è¡£æœ", "å¤–å¥—", "æ€ä¹ˆç©¿"
    );

    private static final List<String> WEATHER_KEYWORDS = List.of(
        "å¤©æ°”", "å‡ åº¦", "æ¸©åº¦", "ä¸‹é›¨", "åˆ®é£"
    );

    public Intent classify(String query) {
        boolean hasClothing = CLOTHING_KEYWORDS.stream()
            .anyMatch(query::contains);
        boolean hasWeather = WEATHER_KEYWORDS.stream()
            .anyMatch(query::contains);

        if (hasClothing && hasWeather) return Intent.BOTH;
        if (hasClothing) return Intent.CLOTHING;
        if (hasWeather) return Intent.WEATHER;
        return Intent.UNKNOWN;
    }
}
```

#### 7.1.3 LLM åˆ†ç±»å®ç°ï¼ˆç”Ÿäº§ï¼‰

```java
@Component
public class LLMIntentClassifier {

    private final ChatClient chatClient;

    private static final String INTENT_PROMPT = """
        åˆ†æç”¨æˆ·æŸ¥è¯¢æ„å›¾ï¼Œä»ä»¥ä¸‹é€‰é¡¹ä¸­é€‰æ‹©ï¼š
        - WEATHER: ä»…æŸ¥è¯¢å¤©æ°”ä¿¡æ¯
        - CLOTHING: ä»…è¯¢é—®ç©¿è¡£å»ºè®®
        - BOTH: æ—¢æŸ¥å¤©æ°”åˆè¦ç©¿è¡£å»ºè®®
        - UNKNOWN: æ— æ³•è¯†åˆ«

        ç”¨æˆ·æŸ¥è¯¢: {query}
        åªè¿”å›æ„å›¾ä»£ç ï¼Œä¸è¦è§£é‡Šã€‚
        """;

    public Intent classify(String query) {
        String result = chatClient.prompt()
            .user(u -> u.text(INTENT_PROMPT).param("query", query))
            .call()
            .content();
        return Intent.valueOf(result.trim());
    }
}
```

---

### 7.2 å’Œé£ API é˜²ç†”æ–­

```java
@Component
public class QWeatherClient {

    private final WebClient webClient;

    @CircuitBreaker(name = "qweather", fallbackMethod = "fallbackToCache")
    @Retry(name = "qweather")
    public WeatherDTO fetch7DayForecast(String cityId) {
        return webClient.get()
            .uri(uriBuilder -> uriBuilder
                .path("/v7/weather/7d/{cityId}")
                .queryParam("key", apiKey)
                .build(cityId))
            .retrieve()
            .bodyToMono(WeatherDTO.class)
            .block();
    }

    // é™çº§æ–¹æ³•ï¼šè¿”å›ç¼“å­˜ä¸­çš„æ—§æ•°æ®
    public WeatherDTO fallbackToCache(String cityId, Throwable ex) {
        log.warn("QWeather API å¤±è´¥ï¼Œé™çº§åˆ°ç¼“å­˜: {}", cityId, ex);
        return cacheService.getWeather(cityId)
            .orElseThrow(() -> new WeatherException("æœåŠ¡æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç¨åé‡è¯•"));
    }
}
```

---

### 7.3 Prompt å·¥ç¨‹ï¼ˆæ ¸å¿ƒäº®ç‚¹ï¼‰

#### 7.3.1 ç³»ç»Ÿ Prompt è®¾è®¡

```yaml
nimbus:
  ai:
    prompts:
      weather-analysis: |
        ä½ æ˜¯ Nimbusï¼Œä¸€ä½ä¸“ä¸šçš„å¤©æ°”åˆ†æå¸ˆã€‚

        è¾“å…¥æ•°æ®ï¼š7å¤©å¤©æ°”é¢„æŠ¥ JSON
        ç”¨æˆ·é—®é¢˜ï¼š{userQuery}

        çº¦æŸï¼š
        1. å¤©æ°”æ€»ç»“ä¸è¶…è¿‡ 3 å¥è¯
        2. æŒ‡å‡ºæ¸©åº¦å‰§çƒˆå˜åŒ–ï¼ˆæ¸©å·®>8â„ƒï¼‰çš„æ—¥æœŸ
        3. æ ‡è®°éœ€è¦ç‰¹åˆ«æ³¨æ„çš„å¤©æ°”ï¼ˆæš´é›¨ã€å¤§é£ã€æç«¯é«˜æ¸©/ä½æ¸©ï¼‰
        4. è¯­æ°”è½»æ¾å‹å¥½ï¼Œé€‚å½“ä½¿ç”¨ emoji

        è¾“å‡ºæ ¼å¼ï¼šçº¯æ–‡æœ¬æ€»ç»“

      clothing-advice: |
        ä½ æ˜¯ Nimbusï¼Œä¸€ä½æ‡‚ç©¿æ­çš„å¤©æ°”åŠ©æ‰‹ã€‚

        å¤©æ°”æ€»ç»“ï¼š{weatherSummary}
        è¯¦ç»†æ•°æ®ï¼š{weatherData}

        çº¦æŸï¼š
        1. ç©¿è¡£å»ºè®®å¿…é¡»åŒ…å«"ä¸Šè£…/ä¸‹è£…/é‹/é…ä»¶"å››ç±»
        2. æœ‰é›¨å¿…æé†’å¸¦ä¼ï¼Œæ¸©å·®>8â„ƒå¿…æé†’æ´‹è‘±ç©¿è¡£æ³•
        3. è€ƒè™‘æ¹¿åº¦ã€é£åŠ›å¯¹ä½“æ„Ÿæ¸©åº¦çš„å½±å“
        4. è¯­æ°”è½»æ¾ï¼Œç”¨ emoji

        è¾“å‡ºæ ¼å¼ï¼ˆä¸¥æ ¼JSONï¼‰ï¼š
        {
          "overview": "ä¸€å¥è¯æ€»ç»“",
          "top": { "name": "å•å“å", "reason": "æ¨èç†ç”±" },
          "bottom": { "name": "å•å“å", "reason": "æ¨èç†ç”±" },
          "shoes": { "name": "å•å“å", "reason": "æ¨èç†ç”±" },
          "extra": { "name": "å•å“å", "reason": "æ¨èç†ç”±" },
          "aiReply": "è‡ªç„¶è¯­è¨€å›å¤"
        }
```

---

### 7.4 åŸå¸‚ ID æ˜ å°„è¡¨

å’Œé£ LocationID æ˜¯ 9 ä½æ•°å­—ï¼ˆå¦‚åŒ—äº¬ 101010100ï¼‰ã€‚

**æ–¹æ¡ˆ**ï¼šå¯åŠ¨æ—¶åŠ è½½ `city-list.json`ï¼ˆå’Œé£æä¾›ï¼‰åˆ° Redis Hash

```java
@Component
public class CityDataInitializer implements CommandLineRunner {

    @Override
    public void run(String... args) throws Exception {
        // ä» resources/city-list.json åŠ è½½
        List<City> cities = loadCityList();

        // å†™å…¥ Redis Hash: nimbus:city
        Map<String, String> cityMap = cities.stream()
            .collect(Collectors.toMap(
                City::getName,
                City::getLocationId,
                (v1, v2) -> v1  // å¤„ç†é‡ååŸå¸‚
            ));

        redisTemplate.opsForHash().putAll("nimbus:city", cityMap);
    }
}
```

---

## 8. API æ¥å£è®¾è®¡

### 8.1 æ¥å£åˆ—è¡¨

| æ–¹æ³• | è·¯å¾„ | è¯´æ˜ |
|:---|:---|:---|
| POST | `/nimbus/chat` | è‡ªç„¶è¯­è¨€æŸ¥è¯¢ï¼ˆä¸»æ¥å£ï¼‰ |
| GET | `/nimbus/weather/{city}` | ç›´æ¥æŸ¥è¯¢å¤©æ°” |
| GET | `/nimbus/cities?q={keyword}` | åŸå¸‚æœç´¢ |
| GET | `/nimbus/health` | å¥åº·æ£€æŸ¥ |

### 8.2 ä¸»æ¥å£è¯¦ç»†è®¾è®¡

#### Request

```http
POST /nimbus/chat
Content-Type: application/json

{
  "query": "ä¸Šæµ·æœªæ¥ä¸€å‘¨æ€ä¹ˆæ ·",
  "userId": "user_123",      // å¯é€‰ï¼Œç”¨äºä¸ªæ€§åŒ–
  "location": {              // å¯é€‰ï¼Œä¼˜å…ˆä½¿ç”¨
    "lat": 31.2304,
    "lon": 121.4737
  }
}
```

#### Response - æˆåŠŸ (200 OK)

```json
{
  "success": true,
  "data": {
    "city": {
      "name": "ä¸Šæµ·",
      "locationId": "101020100"
    },
    "summary": "æœªæ¥ä¸€å‘¨å…ˆæ™´åé›¨ï¼Œå‘¨ä¸‰é™æ¸© ğŸŒ¦ï¸",
    "daily": [
      {
        "date": "2025-02-07",
        "tempMax": "12",
        "tempMin": "6",
        "textDay": "æ™´",
        "textNight": "å¤šäº‘",
        "windDir": "ä¸œåŒ—é£",
        "windScale": "3-4çº§"
      }
      // ... åç»­6å¤©
    ],
    "clothingAdvice": {
      "overview": "å»ºè®®æ˜¥è£…å¤–å¥—+é•¿è£¤",
      "details": {
        "top": { "name": "è–„æ¯›è¡£", "reason": "ç™½å¤©è¾ƒæš–ï¼Œæ—©æ™šå‡‰" },
        "bottom": { "name": "ç‰›ä»”è£¤", "reason": "é˜²é£ä¿æš–" },
        "shoes": { "name": "è¿åŠ¨é‹", "reason": "èˆ’é€‚é€šå‹¤" },
        "extra": { "name": "è½»è–„å¤–å¥—", "reason": "åº”å¯¹é™æ¸©" }
      },
      "aiReply": "ä¸Šæµ·è¿™å‘¨å¤©æ°”ä¸é”™å“¦ï½å‘¨å››è®°å¾—å¸¦ä¼ ğŸŒ‚"
    }
  },
  "timestamp": "2025-02-06T10:30:00Z"
}
```

#### Response - é”™è¯¯ç¤ºä¾‹

```json
{
  "success": false,
  "error": {
    "code": "CITY_NOT_FOUND",
    "message": "æœªæ‰¾åˆ°åŸå¸‚ 'ç«æ˜Ÿ'ï¼Œè¯·æ£€æŸ¥åŸå¸‚åç§°",
    "suggestions": ["å°è¯•ä½¿ç”¨ï¼šåŒ—äº¬ã€ä¸Šæµ·ã€å¹¿å·..."]
  },
  "timestamp": "2025-02-06T10:30:00Z"
}
```

### 8.3 é”™è¯¯ç è§„èŒƒ

| é”™è¯¯ç  | è¯´æ˜ | HTTPçŠ¶æ€ç  |
|:---|:---|:---:|
| `INVALID_REQUEST` | è¯·æ±‚å‚æ•°é”™è¯¯ | 400 |
| `CITY_NOT_FOUND` | åŸå¸‚æœªæ‰¾åˆ° | 404 |
| `WEATHER_API_ERROR` | å¤©æ°”æœåŠ¡å¼‚å¸¸ | 503 |
| `AI_SERVICE_ERROR` | AI æœåŠ¡è¶…æ—¶ | 503 |
| `RATE_LIMITED` | è¯·æ±‚é¢‘ç‡é™åˆ¶ | 429 |
| `INTERNAL_ERROR` | å†…éƒ¨é”™è¯¯ | 500 |


---

## 9. é…ç½®ç®¡ç†

### 9.1 å®Œæ•´é…ç½®ç¤ºä¾‹

```yaml
# application.yml
spring:
  application:
    name: nimbus

  # Redis é…ç½®
  data:
    redis:
      host: localhost
      port: 6379
      database: 0
      timeout: 5s
      lettuce:
        pool:
          max-active: 8
          max-idle: 8

  # AI é…ç½®
  ai:
    openai:
      api-key: ${OPENAI_API_KEY}
      base-url: https://api.openai.com
      chat:
        options:
          model: gpt-4o-mini
          temperature: 0.7
    # æˆ–æ™ºè°± AI
    zhipuai:
      api-key: ${ZHIPU_API_KEY}

# å’Œé£å¤©æ°”é…ç½®
nimbus:
  weather:
    qweather:
      api-key: ${QWEATHER_KEY}
      base-url: https://devapi.qweather.com
      geo-url: https://geoapi.qweather.com

  # ç¼“å­˜é…ç½®
  cache:
    caffeine:
      max-size: 1000
      expire-after-write: 30m
    redis:
      weather-ttl: 1h
      city-ttl: 24h

  # AI Prompt é…ç½®
  ai:
    enabled: true
    timeout: 10s
    prompts:
      location: classpath:/prompts/

# Resilience4j ç†”æ–­é…ç½®
resilience4j:
  circuitbreaker:
    configs:
      default:
        sliding-window-size: 10
        failure-rate-threshold: 50
        wait-duration-in-open-state: 10s
    instances:
      qweather:
        base-config: default
  retry:
    configs:
      default:
        max-attempts: 3
        wait-duration: 1s
```

### 9.2 å¤šç¯å¢ƒé…ç½®

```
nimbus-bootstrap/src/main/resources/
â”œâ”€â”€ application.yml          # å…¬å…±é…ç½®
â”œâ”€â”€ application-dev.yml      # å¼€å‘ç¯å¢ƒ
â”œâ”€â”€ application-test.yml     # æµ‹è¯•ç¯å¢ƒ
â”œâ”€â”€ application-prod.yml     # ç”Ÿäº§ç¯å¢ƒ
â””â”€â”€ prompts/                 # Prompt æ¨¡æ¿
    â”œâ”€â”€ weather-analysis.txt
    â”œâ”€â”€ clothing-advice.txt
    â””â”€â”€ intent-classify.txt
```

---

## 10. å¼‚å¸¸å¤„ç†ä¸é™çº§

### 10.1 å¼‚å¸¸å¤„ç†ç­–ç•¥

| å¼‚å¸¸åœºæ™¯ | å¤„ç†ç­–ç•¥ | é™çº§æ–¹æ¡ˆ |
|:---|:---|:---|
| QWeather API é™æµ | Resilience4j ç†”æ–­ | è¿”å›ç¼“å­˜æ•°æ® |
| QWeather API æ•…éšœ | 3æ¬¡é‡è¯•åç†”æ–­ | è¿”å›ç¼“å­˜æ•°æ®+å‹å¥½æç¤º |
| AI æœåŠ¡è¶…æ—¶ | 3sè¶…æ—¶é™åˆ¶ | è¿”å›åŸºç¡€ç©¿è¡£è§„åˆ™ç»“æœ |
| Redis æ•…éšœ | å¼‚å¸¸æ•è·ä¸ä¸­æ–­ | é™çº§åˆ°Caffeineæœ¬åœ°ç¼“å­˜ |
| åŸå¸‚IDæœªæ‰¾åˆ° | è°ƒç”¨GeoAPIæœç´¢ | æç¤ºç”¨æˆ·é€‰æ‹©æ­£ç¡®åŸå¸‚å |

### 10.2 å…¨å±€å¼‚å¸¸å¤„ç†å™¨

```java
@RestControllerAdvice
@Slf4j
public class GlobalExceptionHandler {

    @ExceptionHandler(CityNotFoundException.class)
    public ResponseEntity<ErrorResponse> handleCityNotFound(CityNotFoundException e) {
        return ResponseEntity.status(HttpStatus.NOT_FOUND)
            .body(ErrorResponse.builder()
                .code("CITY_NOT_FOUND")
                .message(e.getMessage())
                .suggestions(List.of("å°è¯•ä½¿ç”¨ï¼šåŒ—äº¬ã€ä¸Šæµ·ã€å¹¿å·..."))
                .build());
    }

    @ExceptionHandler(WeatherApiException.class)
    public ResponseEntity<ErrorResponse> handleWeatherApiError(WeatherApiException e) {
        log.error("å¤©æ°”æœåŠ¡å¼‚å¸¸", e);
        return ResponseEntity.status(HttpStatus.SERVICE_UNAVAILABLE)
            .body(ErrorResponse.builder()
                .code("WEATHER_API_ERROR")
                .message("å¤©æ°”æœåŠ¡æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç¨åé‡è¯•")
                .build());
    }

    @ExceptionHandler(Exception.class)
    public ResponseEntity<ErrorResponse> handleGeneric(Exception e) {
        log.error("ç³»ç»Ÿå¼‚å¸¸", e);
        return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR)
            .body(ErrorResponse.builder()
                .code("INTERNAL_ERROR")
                .message("ç³»ç»Ÿç¹å¿™ï¼Œè¯·ç¨åé‡è¯•")
                .build());
    }
}
```

---

## 11. æµ‹è¯•ç­–ç•¥

### 11.1 æµ‹è¯•åˆ†å±‚

```
test/
â”œâ”€â”€ unit/                    # å•å…ƒæµ‹è¯•
â”‚   â”œâ”€â”€ intent/
â”‚   â”‚   â””â”€â”€ IntentClassifierTest.java
â”‚   â”œâ”€â”€ service/
â”‚   â”‚   â””â”€â”€ WeatherQueryServiceTest.java
â”‚   â””â”€â”€ domain/
â”‚       â””â”€â”€ ClothingAdviceTest.java
â”œâ”€â”€ integration/             # é›†æˆæµ‹è¯•
â”‚   â”œâ”€â”€ cache/
â”‚   â”‚   â””â”€â”€ RedisCacheTest.java
â”‚   â”œâ”€â”€ ai/
â”‚   â”‚   â””â”€â”€ ChatClientTest.java
â”‚   â””â”€â”€ api/
â”‚       â””â”€â”€ WeatherControllerTest.java
â””â”€â”€ contract/                # å¥‘çº¦æµ‹è¯•
    â””â”€â”€ QWeatherApiContractTest.java
```

### 11.2 å…³é”®æµ‹è¯•ç”¨ä¾‹

#### Prompt æµ‹è¯•

```java
@SpringBootTest
class PromptTemplateTest {

    @Autowired
    private ChatClient chatClient;

    @Test
    void testWeatherAnalysisPrompt() {
        String result = chatClient.prompt()
            .user("åˆ†æä»¥ä¸‹å¤©æ°”ï¼š{ \"temp\": 25, \"condition\": \"æ™´\" }")
            .call()
            .content();

        assertThat(result).containsAnyOf("æ™´", "æ¸©åº¦");
    }
}
```

#### API å¥‘çº¦æµ‹è¯•ï¼ˆWireMockï¼‰

```java
@SpringBootTest
@AutoConfigureWireMock(port = 0)
class QWeatherContractTest {

    @Value("${wiremock.server.port}")
    private int wireMockPort;

    @Test
    void testFetch7DayForecast() {
        // é…ç½® WireMock
        stubFor(get(urlPathMatching("/v7/weather/7d/.*"))
            .willReturn(aResponse()
                .withStatus(200)
                .withHeader("Content-Type", "application/json")
                .withBodyFile("qweather-7d-response.json")));

        // æ‰§è¡Œæµ‹è¯•...
    }
}
```

---

## 12. æ‰©å±•è§„åˆ’

### 12.1 Function Callingï¼ˆé«˜çº§ç‰¹æ€§ï¼‰

è®© LLM è‡ªå·±å†³å®šè¦ä¸è¦è°ƒç”¨å¤©æ°” APIï¼š

```java
@Bean
public FunctionCallback weatherFunction(QWeatherClient client) {
    return FunctionCallback.builder()
        .function("getWeather", new WeatherFunction(client))
        .description("è·å–æŒ‡å®šåŸå¸‚çš„å¤©æ°”ä¿¡æ¯")
        .inputType(WeatherRequest.class)
        .build();
}
```

### 12.2 ç”¨æˆ·ç”»åƒ

```java
@Entity
public class UserPreference {
    private String userId;
    private TemperatureSensitivity tempSensitivity; // COLD_SENSITIVE / HOT_SENSITIVE / NORMAL
    private StylePreference style; // CASUAL / FORMAL / SPORT
    private Set<String> favoriteCities;
}
```

### 12.3 å®šæ—¶é¢„å–

```java
@Component
@Slf4j
public class WeatherPrefetchJob {

    @Scheduled(cron = "0 0 3 * * ?") // æ¯å¤©å‡Œæ™¨3ç‚¹
    public void prefetchPopularCities() {
        // è·å–ç”¨æˆ·å¸¸æŸ¥çš„TOP20åŸå¸‚
        // é¢„æ‹‰æ•°æ®å…¥ç¼“å­˜
    }
}
```

### 12.4 æç«¯å¤©æ°”é¢„è­¦ï¼ˆWebSocketï¼‰

```java
@Component
public class WeatherAlarmService {

    @Scheduled(fixedDelay = 60000) // æ¯åˆ†é’Ÿæ£€æŸ¥
    public void checkAlarms() {
        // è°ƒå’Œé£ Alarms API
        // æ¨é€ WebSocket æ¶ˆæ¯
    }
}
```

---

## 13. å¼€å‘é‡Œç¨‹ç¢‘

| é˜¶æ®µ | ç›®æ ‡ | äº§å‡º | é¢„è®¡å·¥æœŸ |
|:---|:---|:---|:---:|
| **MVP** | åŸºç¡€å¤©æ°”æŸ¥è¯¢+ç®€å•ç©¿è¡£è§„åˆ™ | å•æ¨¡å— SpringBootï¼Œç¡¬ç¼–ç 10åŸå¸‚ | 3å¤© |
| **V1.0** | æ¥å…¥ Spring AIï¼Œè‡ªç„¶è¯­è¨€å›å¤ | å¤šæ¨¡å—æ‹†åˆ†ï¼ŒPrompt è°ƒä¼˜ | 5å¤© |
| **V1.5** | åŠ ç¼“å­˜+åŸå¸‚æœç´¢+å¼‚å¸¸å¤„ç† | å¯æ¼”ç¤ºçš„å®Œæ•´é¡¹ç›® | 5å¤© |
| **V2.0** | Function Calling + ç”¨æˆ·ç”»åƒ | æ™ºèƒ½åŒ–è¿›é˜¶ç‰ˆæœ¬ | 7å¤© |
| **V2.5** | å®šæ—¶é¢„å– + æç«¯å¤©æ°”é¢„è­¦ | ä¼ä¸šçº§å¯ç”¨ç‰ˆæœ¬ | 7å¤© |

### 13.1 MVP ä»»åŠ¡æ‹†è§£

- [ ] æ­å»º SpringBoot å•æ¨¡å—é¡¹ç›®
- [ ] é›†æˆ WebClient è°ƒç”¨å’Œé£ API
- [ ] å®ç°å¤©æ°”æ•°æ® JSON è§£æ
- [ ] ç¡¬ç¼–ç  10 ä¸ªçƒ­é—¨åŸå¸‚
- [ ] åŸºäºæ¸©åº¦è§„åˆ™çš„ç©¿è¡£å»ºè®®
- [ ] å•æµ‹è¦†ç›–æ ¸å¿ƒé€»è¾‘

---

## 14. å‚è€ƒèµ„æº

### 14.1 å®˜æ–¹æ–‡æ¡£

| èµ„æº | é“¾æ¥ |
|:---|:---|
| Spring AI å®˜æ–¹æ–‡æ¡£ | https://docs.spring.io/spring-ai/reference/ |
| Spring AI GitHub | https://github.com/spring-projects/spring-ai |
| å’Œé£å¤©æ°” API æ–‡æ¡£ | https://dev.qweather.com/docs/ |
| Resilience4j æ–‡æ¡£ | https://resilience4j.readme.io/ |

### 14.2 æœ¯è¯­è¡¨

| æœ¯è¯­ | è¯´æ˜ |
|:---|:---|
| **Function Calling** | LLM è°ƒç”¨å¤–éƒ¨å‡½æ•°çš„èƒ½åŠ› |
| **LocationID** | å’Œé£å¤©æ°”çš„åŸå¸‚å”¯ä¸€æ ‡è¯†ï¼ˆ9ä½æ•°å­—ï¼‰ |
| **Prompt Engineering** | è®¾è®¡å’Œä¼˜åŒ– AI æç¤ºè¯çš„æŠ€æœ¯ |
| **Circuit Breaker** | ç†”æ–­å™¨æ¨¡å¼ï¼Œé˜²æ­¢çº§è”æ•…éšœ |
| **DDD** | é¢†åŸŸé©±åŠ¨è®¾è®¡ (Domain-Driven Design) |

---

*æ–‡æ¡£ç‰ˆæœ¬: v1.0*
*æœ€åæ›´æ–°: 2025-02-06*
