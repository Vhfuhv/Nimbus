# Nimbus Agent 路线图（并发与分布式）

本文档聚焦 Java 项目的两条核心主线：并发治理、分布式能力。

## 1. 第一优先级：并发治理

### 1.1 用户与会话隔离
- 目标：避免高并发下会话串线。
- 动作：会话主键改为 `userId + sessionId`，禁止默认共享用户。
- 落地：请求头读取 `X-User-Id`，缺失时兜底 `guest-{sessionId}`。

### 1.2 外部依赖保护
- 目标：防止 DashScope / QWeather 拖垮服务。
- 动作：增加超时、有限重试、熔断、降级文案。
- 建议：使用 Resilience4j（`TimeLimiter` + `Retry` + `CircuitBreaker`）。

### 1.3 限流与背压
- 目标：控制突发流量，保障核心请求可用。
- 动作：按 `userId` 做令牌桶限流；按接口分级限流。
- 建议：Redis + Lua 实现原子限流；SSE 增加连接上限。

### 1.4 线程模型审视
- 目标：减少阻塞，提高吞吐。
- 动作：SSE、工具调用、外部 HTTP 调用分别评估线程占用。
- 建议：优先用 Reactor 链路，避免无边界异步任务池。

## 2. 第二优先级：分布式落地

### 2.1 分布式会话记忆
- 目标：实例重启/扩容后会话不丢失。
- 动作：ChatMemory 从内存迁移到 Redis。
- 细节：设置 TTL、消息窗口、摘要压缩策略。

### 2.2 全链路可观测
- 目标：可定位慢点和失败点。
- 动作：统一 `traceId`，关联用户、会话、工具调用。
- 指标：`qps`、`p95/p99`、工具耗时、外部调用失败率。

### 2.3 配置中心化
- 目标：多环境一致、可灰度。
- 动作：提示词、模型参数、阈值项外置配置。
- 建议：预留 Nacos / Apollo / Spring Cloud Config 接入点。

### 2.4 数据与审计
- 目标：支持运营与问题回放。
- 动作：落表 `user/session/tool_trace/error` 关键数据。
- 建议：先 MySQL，后续按量迁移到 OLAP。

## 3. 简历可写的技术成果模板

### 3.1 并发方向
- 基于 Spring AI 构建多轮 Agent，对话会话按 `userId + sessionId` 隔离。
- 引入限流、熔断与重试机制，提升高并发场景稳定性。

### 3.2 分布式方向
- 将会话记忆迁移至 Redis，实现多实例下上下文一致性。
- 建立 `traceId + toolTrace` 可观测链路，提升故障定位效率。

### 3.3 性能方向
- 完成压测基线与优化对比，输出 P95/P99 与错误率改进数据。

## 4. 建议实施顺序（可直接按周推进）

1. 会话隔离（userId + sessionId）
2. 限流与外部依赖熔断
3. Redis 会话记忆迁移
4. 指标与链路追踪完善
5. 压测与简历材料沉淀

---

备注：
- 每完成一项能力，补一段可复现压测数据。
- 简历重点写“问题 -> 方案 -> 指标结果”。
